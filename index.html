<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spazio Sicuro</title>

<style>
* { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
body { margin:0; background: linear-gradient(135deg,#0f0f0f,#1a1a2e); color:#f1f1f1; display:flex; justify-content:center; align-items:center; height:100vh; }
.container { width:100%; max-width:420px; padding:24px; text-align:center; animation: fadeIn 0.6s ease; }
h1 { font-weight:600; font-size:1.8em; margin-bottom:16px; text-shadow:1px 1px 4px rgba(0,0,0,0.7); }
p { color:#d0d0d0; line-height:1.6; }
button { width:100%; padding:14px; margin-top:16px; background:linear-gradient(90deg,#1c1c1c,#2a2a2a); color:#f1f1f1; border:none; border-radius:12px; font-size:16px; cursor:pointer; transition: background 0.3s, transform 0.2s; }
button:hover { transform: scale(1.03); }
button:active { transform: scale(0.98); }
button.recording { background: #8b0000; }
button.pulse { animation: pulse 2s infinite; }
.hidden { display:none; }
textarea { width:100%; height:150px; background:#1a1a1a; color:#f1f1f1; border:none; border-radius:12px; padding:12px; font-size:15px; resize:none; margin-top:16px; box-shadow: inset 0 0 10px rgba(255,255,255,0.05); }
canvas {
  width:100%;
  height:240px;
  background:linear-gradient(to bottom,#1a1a1a,#0f0f0f);
  border-radius:8px;
  margin-top:16px;
  touch-action: none;
}
.support {
  background:#141414;
  border-left:3px solid #6f9cff;
  padding:12px;
  margin-top:16px;
  font-size:14px;
  color:#e0e0e0;
  opacity:0;
  transition: opacity 0.6s ease;
}
.support.show { opacity:1; }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes pulse { 0%,100%{transform: scale(1);} 50%{transform: scale(1.05);} }
</style>
</head>

<body>

<div class="container" id="welcome">
  <h1>Benvenuto nel tuo spazio sicuro</h1>
  <p>Qui puoi scrivere, disegnare o parlare liberamente.<br>Nessuno ti giudica. Nulla viene salvato.</p>
  <button class="pulse" onclick="goToModes()">Entra</button>
</div>

<div class="container hidden" id="modes">
  <p>Scegli come esprimerti</p>
  <button onclick="openWrite()">‚úçÔ∏è Scrivi</button>
  <button onclick="openDraw()">üñ§ Disegna</button>
  <button onclick="openVoice()">üéôÔ∏è Parla</button>
</div>

<div class="container hidden" id="write">
  <textarea id="writeText" placeholder="Scrivi come viene..."></textarea>
  <div id="writeSupport" class="support hidden"></div>
  <button onclick="release()">Lascia andare</button>
  <button onclick="eliminate()">Elimina</button>
</div>

<div class="container hidden" id="draw">
  <canvas id="canvas"></canvas>
  <div id="drawSupport" class="support hidden"></div>
  <button onclick="release()">Lascia andare</button>
  <button onclick="eliminate()">Elimina</button>
</div>

<div class="container hidden" id="voice">
  <p>Tieni premuto e parla</p>
  <button id="recordBtn">üéôÔ∏è Tieni premuto</button>
  <textarea id="transcript" readonly placeholder="Le tue parole appariranno qui..."></textarea>
  <div id="voiceSupport" class="support hidden"></div>
  <button onclick="release()">Lascia andare</button>
  <button onclick="eliminate()">Elimina</button>
</div>

<div class="container hidden" id="done"><p></p><button onclick="reset()">Torna all'inizio</button></div>
<div class="container hidden" id="eliminated"><p></p><button onclick="reset()">Torna all'inizio</button></div>

<script>
/* ===== NAV ===== */
function hideAll(){ document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden')); }
function goToModes(){ hideAll(); modes.classList.remove('hidden'); }
function openWrite(){ hideAll(); write.classList.remove('hidden'); }
function openDraw(){ hideAll(); draw.classList.remove('hidden'); initCanvas(); }
function openVoice(){ hideAll(); voice.classList.remove('hidden'); }

/* ===== MESSAGGI RANDOM ===== */
const releasedMessages = [
  "Hai condiviso qualcosa, anche solo con te stesso.",
  "Ogni parola lasciata andare √® un piccolo sollievo.",
  "Hai fatto spazio dentro di te.",
  "Lasciare andare √® un atto di cura."
];

const eliminatedMessages = [
  "Hai scelto di non trattenere ci√≤ che pesava.",
  "Anche eliminare pu√≤ essere liberatorio.",
  "Non tutto deve restare.",
  "Hai fatto ci√≤ che serviva in questo momento."
];

const stressSupportMessages = [
  "Sembra che tu stia portando molto peso addosso.<br>Qui puoi fermarti un momento.",
  "Sentirsi stanchi o sotto pressione √® umano.<br>Non devi dimostrare nulla.",
  "Anche solo scrivere qui √® gi√† un modo per alleggerire.",
  "Non sei solo in quello che provi. Prenditi il tempo che ti serve."
];

const sadnessMessages = [
  "Va bene sentirsi gi√π. Prenditi il tuo tempo per respirare e osservare cosa provi.",
  "A volte ci sentiamo tristi senza un motivo preciso. Sei al sicuro qui.",
  "Non devi affrontare tutto da solo. Anche scrivere o respirare pu√≤ aiutare.",
  "√à normale avere momenti di sconforto. Qui puoi sentirti ascoltato.",
  "La tristezza √® parte dell‚Äôessere umano. Permettiti di viverla senza fretta."
];


const supportMessages = [
  "Va bene cercare aiuto. Non sei solo in quello che provi.",
  "Sentirsi soli pu√≤ essere pesante. Qui puoi prenderti un momento per te.",
  "A volte parlare con qualcuno aiuta a sentirsi meglio. Respira, sei al sicuro qui.",
  "Hai il diritto di essere ascoltato. Anche solo scrivere √® un modo per farlo.",
  "√à normale aver bisogno di supporto. Qui puoi sentirti accolto senza giudizio."
];


const confusionMessages = [
  "Va bene sentirsi confusi. Fai un respiro e prenditi un momento per te.",
  "A volte non sapere cosa fare √® normale. Qui puoi rallentare senza fretta.",
  "Pu√≤ aiutare scrivere o disegnare quello che senti. Sei al sicuro qui.",
  "La confusione non significa che sia sbagliato ci√≤ che provi. Permettiti di esplorare con calma.",
  "Quando tutto sembra confuso, piccoli passi aiutano a ritrovare il centro. Respira."
];


function randomMessage(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* ===== RELEASE ===== */
function release(){
  hideAll();
  done.classList.remove("hidden");
  done.querySelector("p").innerHTML = randomMessage(releasedMessages);
}
function eliminate(){
  hideAll();
  eliminated.classList.remove("hidden");
  eliminated.querySelector("p").innerHTML = randomMessage(eliminatedMessages);
}
function reset(){ location.reload(); }

/* ===== SAFETY WORDS ===== */
const selfHarmWords = [
  "suicid","ammazzarm","ucciderm","voglio morire",
  "non voglio vivere","farla finita","farmi del male",
  "vorrei sparire","meglio morto", "mor"
];

const harmOthersWords = [
  "ammazz","uccid","violen","fare del male",
  "vendetta","gliela far√≤ pagare","lo uccido", "mor"
];

/* ===== STRESS WORDS ===== */
const stressWords = [
  "stress",
  "stanc",
  "esaust",
  "sfin",
  "non ce la faccio",
  "sono al limite",
  "pressione",
  "sotto pressione",
  "troppo da fare",
  "sopraffatt",
  "nervos",
  "ansi",
  "agit",
  "ho bisogno di una pausa",
  "non respiro",
  "mi sento pien",
  "mi sento svuotat"
];


/* ===== CONFUSION WORDS ===== */
const confusionWords = [
  "non capisco",
  "sono confus",
  "mi sento pers",
  "mi sento confus",
  "non so cosa fare",
  "non so da dove iniziare",
  "sono bloccat",
  "mi sento pers",
  "tutto confuso",
  "non ci sto capendo nulla",
  "ho la testa piena",
  "non riesco a pensare"
];


/* ===== SUPPORT WORDS ===== */
const needSupportWords = [
  "ho bisogno di",
  "avrei bisogno di aiuto",
  "non so con chi parlare",
  "mi sento solo",
  "mi sento sola",
  "nessuno mi ascolta",
  "vorrei qualcuno",
  "ho bisogno di parlare",
  "ho bisogno di essere ascoltat",
  "male"
];


/* ===== SADNESS WORDS ===== */
const sadnessWords = [
  "trist",
  "piango",
  "mi sento gi√π",
  "sono a terra",
  "abbattut",
  "mi sento vuot",
  "niente mi va",
  "non ho voglia di niente",
  "sono demoralizzat"
];



function checkText(text, box){
  const t = text.toLowerCase();

  const categories = [
    { words: selfHarmWords, messages: ["Quello che provi merita ascolto e cura.<br>La vita √® preziosa, anche quando pesa molto.<br>Se questo spazio non basta, parlarne con qualcuno pu√≤ aiutare."] },
    { words: harmOthersWords, messages: ["Rabbia e dolore sono emozioni umane.<br>Il rispetto per la vita, nostra e degli altri, resta fondamentale.<br>Quando possibile, parlarne pu√≤ aiutare a chiarire."] },
    { words: sadnessWords, messages: sadnessMessages },
    { words: needSupportWords, messages: supportMessages },
    { words: confusionWords, messages: confusionMessages },
    { words: stressWords, messages: stressSupportMessages }
  ];

  for(const cat of categories){
    if(cat.words.some(w => t.includes(w))){
      box.innerHTML = randomMessage(cat.messages);
      box.classList.add("show");
      box.classList.remove("hidden");
      return;
    }
  }

  box.classList.remove("show");
  box.classList.add("hidden");
}

writeText.addEventListener("input", e => checkText(e.target.value, writeSupport));

/* ===== VOICE ===== */
let recognition;
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if(SR){
  recognition = new SR();
  recognition.lang = "it-IT";
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.onresult = e => {
    let text = "";
    for(let i=0;i<e.results.length;i++) text += e.results[i][0].transcript;
    transcript.value = text;
    checkText(text, voiceSupport);
  };
}

recordBtn.onmousedown = startRec;
recordBtn.onmouseup = stopRec;
recordBtn.ontouchstart = startRec;
recordBtn.ontouchend = stopRec;

function startRec(){
  recordBtn.textContent = "üéôÔ∏è Sto ascoltando...";
  recordBtn.classList.add("recording");
  if(recognition) recognition.start();
}
function stopRec(){
  recordBtn.textContent = "üéôÔ∏è Tieni premuto";
  recordBtn.classList.remove("recording");
  if(recognition) recognition.stop();
}

/* ===== CANVAS COSTANTI ===== */
const HOLD_TIME = 2000;
const FADE_SPEED = 0.01;
const IDLE_TIME = 5000; // 5 secondi prima della dissolvenza


/* ===== CANVAS ===== */
function initCanvas(){
  const c = canvas;
  const ctx = c.getContext("2d");
  c.width = c.offsetWidth;
  c.height = c.offsetHeight;

  let particles = [];
  let drawing = false;
  let frozen = false;
  let stopTime = null;
  let globalAlpha = 1;

  let lastX = 0, lastY = 0;
  let startTime = 0;
  let strokeCount = 0;
  let directionChanges = 0;
  let lastDirection = null;

  let drawSupportShown = false;
  let chaosSupportShown = false;

  drawSupport.classList.remove("show");
  drawSupport.classList.add("hidden");

  function getPos(e){
    const r = c.getBoundingClientRect();
    return {
      x: (e.clientX - r.left) * (c.width / r.width),
      y: (e.clientY - r.top) * (c.height / r.height)
    };
  }

  function addParticle(x,y){
    particles.push({ x, y, r: 2.8 });
  }

  c.onpointerdown = e => {
    drawing = true;
    frozen = false;
    stopTime = null;
    startTime = Date.now();
    strokeCount = 0;
    directionChanges = 0;
    lastDirection = null;
 	globalAlpha = 1;

    const pos = getPos(e);
    lastX = pos.x;
    lastY = pos.y;

    c.setPointerCapture(e.pointerId);
  };

  c.onpointerup = e => {
    drawing = false;
    stopTime = Date.now();
    c.releasePointerCapture(e.pointerId);
  };

  c.onpointerleave = () => {
    if(drawing){
      drawing = false;
      frozen = true;
      stopTime = Date.now();
    }
  };

  c.onpointermove = e => {
    if(!drawing) return;

    const pos = getPos(e);
    const dx = pos.x - lastX;
    const dy = pos.y - lastY;

    strokeCount++;

    let dir =
      Math.abs(dx) > Math.abs(dy)
        ? (dx > 0 ? "right" : "left")
        : (dy > 0 ? "down" : "up");

    if(lastDirection && dir !== lastDirection){
      directionChanges++;
    }
    lastDirection = dir;

    addParticle(pos.x,pos.y);
    lastX = pos.x;
    lastY = pos.y;

    checkDrawing();
  };

  function checkDrawing(){
    const elapsed = (Date.now() - startTime) / 1000;

    if(!drawSupportShown && strokeCount > 300 && elapsed > 4){
      drawSupportShown = true;
      showDrawSupport(
        "Sembra che tu stia scaricando molta tensione.<br>" +
        "Prenderti un momento per respirare pu√≤ aiutare.<br>" +
        "Sei al sicuro qui."
      );
      return;
    }

    if(!chaosSupportShown && directionChanges > 15){
      chaosSupportShown = true;
      showDrawSupport(
        "Il rispetto per la vita, nostra e degli altri, √® fondamentale.<br>" +
        "Se stai provando rabbia o confusione, parlarne pu√≤ aiutare."
      );
    }
  }

  function showDrawSupport(text){
    drawSupport.innerHTML = text;
    drawSupport.classList.add("show");
    drawSupport.classList.remove("hidden");
  }

  function animate(){
    ctx.clearRect(0,0,c.width,c.height);

   if(!drawing && stopTime && Date.now() - stopTime > IDLE_TIME){
  frozen = true; }

  if(frozen){
  globalAlpha -= FADE_SPEED;

  if(globalAlpha <= 0){
    globalAlpha = 0;
    particles = [];
    frozen = false;
    stopTime = null;
  }
}
    ctx.globalAlpha = globalAlpha;

    particles.forEach(p=>{
      const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r);
      g.addColorStop(0,"rgba(220,220,241,1)");
      g.addColorStop(1,"rgba(241,241,241,0)");
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    });

    ctx.globalAlpha = 1;
    requestAnimationFrame(animate);
  }

  animate();
}
</script>

</body>
</html>
