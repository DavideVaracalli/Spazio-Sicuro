<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spazio Sicuro</title>

<style>
* { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
body { margin:0; background: linear-gradient(135deg,#0f0f0f,#1a1a2e); color:#f1f1f1; display:flex; justify-content:center; align-items:center; height:100vh; }
.container { width:100%; max-width:420px; padding:24px; text-align:center; animation: fadeIn 0.6s ease; }
h1 { font-weight:600; font-size:1.8em; margin-bottom:16px; text-shadow:1px 1px 4px rgba(0,0,0,0.7); }
p { color:#d0d0d0; line-height:1.6; }
button { width:100%; padding:14px; margin-top:16px; background:linear-gradient(90deg,#1c1c1c,#2a2a2a); color:#f1f1f1; border:none; border-radius:12px; font-size:16px; cursor:pointer; transition: background 0.3s, transform 0.2s; }
button:hover { transform: scale(1.03); } 
button:active { transform: scale(0.98); } 
button.recording { background: #8b0000; } 
button.pulse { animation: pulse 2s infinite; }
.hidden { display:none; }
textarea { width:100%; height:150px; background:#1a1a1a; color:#f1f1f1; border:none; border-radius:12px; padding:12px; font-size:15px; resize:none; margin-top:16px; box-shadow: inset 0 0 10px rgba(255,255,255,0.05); }
canvas {
  width:100%;
  height:240px;
  background:linear-gradient(to bottom,#1a1a1a,#0f0f0f);
  border-radius:8px;
  margin-top:16px;
  touch-action: none; /* ‚úÖ TOUCH FIX */
}
.support { background:#141414; border-left:3px solid #6f9cff; padding:12px; margin-top:16px; font-size:14px; color:#e0e0e0; opacity:0; transition: opacity 0.6s ease; }
.support.show { opacity:1; }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes pulse { 0%,100%{transform: scale(1);} 50%{transform: scale(1.05);} }
</style>
</head>

<body>

<div class="container" id="welcome">
  <h1>Benvenuto nel tuo spazio sicuro</h1>
  <p>Qui puoi scrivere, disegnare o parlare liberamente.<br>Nessuno ti giudica. Nulla viene salvato.</p>
  <button class="pulse" onclick="goToModes()">Entra</button>
</div>

<div class="container hidden" id="modes">
  <p>Scegli come esprimerti</p>
  <button onclick="openWrite()">‚úçÔ∏è Scrivi</button>
  <button onclick="openDraw()">üñ§ Disegna</button>
  <button onclick="openVoice()">üéôÔ∏è Parla</button>
</div>

<div class="container hidden" id="write">
  <textarea id="writeText" placeholder="Scrivi come viene..."></textarea>
  <div id="writeSupport" class="support hidden"></div>
  <button onclick="release()">Lascia andare</button>
  <button onclick="eliminate()">Elimina</button>
</div>

<div class="container hidden" id="draw">
  <canvas id="canvas"></canvas>
  <div id="drawSupport" class="support hidden"></div>
  <button onclick="release()">Lascia andare</button>
  <button onclick="eliminate()">Elimina</button>
</div>

<div class="container hidden" id="voice">
  <p>Tieni premuto e parla</p>
  <button id="recordBtn">üéôÔ∏è Tieni premuto</button>
  <textarea id="transcript" readonly placeholder="Le tue parole appariranno qui..."></textarea>
  <div id="voiceSupport" class="support hidden"></div>
  <button onclick="release()">Lascia andare</button>
  <button onclick="eliminate()">Elimina</button>
</div>

<div class="container hidden" id="done"><p></p><button onclick="reset()">Torna all'inizio</button></div>
<div class="container hidden" id="eliminated"><p></p><button onclick="reset()">Torna all'inizio</button></div>

<script>
/* ===== NAV ===== */
function hideAll(){ document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden')); }
function goToModes(){ hideAll(); modes.classList.remove('hidden'); }
function openWrite(){ hideAll(); write.classList.remove('hidden'); }
function openDraw(){ hideAll(); draw.classList.remove('hidden'); initCanvas(); }
function openVoice(){ hideAll(); voice.classList.remove('hidden'); }

/* ===== MESSAGES CASUALI ===== */
const eliminatedMessages = [
  "Non avere paura di esprimere i tuoi pensieri. Sfogarsi fa bene.",
  "Liberare ci√≤ che senti √® un passo verso il tuo benessere.",
  "Hai fatto bene a lasciare andare ci√≤ che pesava.",
  "Ricorda: esprimersi non √® mai sbagliato."
];
const releasedMessages = [
  "Hai condiviso il tuo pensiero, anche solo con te stesso.",
  "Ogni parola lasciata andare √® un piccolo sollievo.",
  "Bene, hai fatto spazio dentro di te.",
  "Lasciare andare fa parte del prendersi cura di s√©."
];
function randomMessage(array){ return array[Math.floor(Math.random()*array.length)]; }

/* ===== PARTICELLE DI RILASCIO ===== */
function releaseParticles(){
  const c = canvas; if(!c) return;
  const ctx = c.getContext("2d");
  let releaseParticlesArray = [];
  for(let i=0;i<50;i++){
    releaseParticlesArray.push({
      x: c.width/2 + (Math.random()-0.5)*c.width/2,
      y: c.height,
      alpha: 1,
      radius: Math.random()*5+2,
      dy: -(Math.random()*2+1),
      dx: (Math.random()-0.5)*1
    });
  }
  function animateRelease(){
    ctx.clearRect(0,0,c.width,c.height);
    releaseParticlesArray.forEach((p,i)=>{
      const grad=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.radius);
      grad.addColorStop(0,`rgba(${200+Math.random()*55},${200+Math.random()*55},241,${p.alpha})`);
      grad.addColorStop(1,`rgba(241,241,241,0)`);
      ctx.fillStyle=grad;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.radius,0,Math.PI*2);
      ctx.fill();
      p.alpha-=0.01; p.x+=p.dx; p.y+=p.dy;
      if(p.alpha<=0) releaseParticlesArray.splice(i,1);
    });
    if(releaseParticlesArray.length>0) requestAnimationFrame(animateRelease);
  }
  animateRelease();
}

/* ===== FUNZIONI RELEASE/ELIMINATE ===== */
function release(){
  hideAll(); done.classList.remove("hidden");
  done.querySelector('p').innerHTML=randomMessage(releasedMessages);
  releaseParticles();
}
function eliminate(){
  hideAll(); eliminated.classList.remove("hidden");
  eliminated.querySelector('p').innerHTML=randomMessage(eliminatedMessages);
  releaseParticles();
}
function reset(){ location.reload(); }

/* ===== SAFETY WORDS ===== */
const selfHarmWords=["suicid","ammazzarm","ucciderm","voglio morire","non voglio vivere","farla finita","farmi del male","vorrei sparire","meglio morto"];
const harmOthersWords=["ammazz","uccid","male","violen","fare del male","violenza","vendetta","gliela far√≤ pagare","lo uccido","fare male"];
function checkText(text,box){
  const t=text.toLowerCase();
  if(selfHarmWords.some(w=>t.includes(w))){
    box.innerHTML=`La vita √® un dono prezioso, anche quando sembra difficile da portare.<br>Quello che provi merita ascolto e cura.<br>Se questo spazio non basta, parlarne con qualcuno pu√≤ aiutare.`;
    box.classList.add("show"); box.classList.remove("hidden");
  }else if(harmOthersWords.some(w=>t.includes(w))){
    box.innerHTML=`La vita degli altri ha lo stesso valore della nostra.<br>Rabbia e dolore sono umani.<br>Quando possibile, parlarne con chi pu√≤ aiutare a chiarire pu√≤ fare la differenza.`;
    box.classList.add("show"); box.classList.remove("hidden");
  }else{ box.classList.remove("show"); box.classList.add("hidden"); }
}
writeText.addEventListener("input", e=>checkText(e.target.value, writeSupport));

/* ===== VOICE ===== */
let recognition;
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if(SR){
  recognition = new SR();
  recognition.lang="it-IT";
  recognition.continuous=true;
  recognition.interimResults=true;
  recognition.onresult=e=>{
    let text="";
    for(let i=0;i<e.results.length;i++) text+=e.results[i][0].transcript;
    transcript.value=text;
    checkText(text,voiceSupport);
  };
}
recordBtn.onmousedown=startRec;
recordBtn.onmouseup=stopRec;
recordBtn.ontouchstart=startRec;
recordBtn.ontouchend=stopRec;
function startRec(){ recordBtn.textContent="üéôÔ∏è Sto ascoltando..."; recordBtn.classList.add("recording"); if(recognition) recognition.start(); }
function stopRec(){ recordBtn.textContent="üéôÔ∏è Tieni premuto"; recordBtn.classList.remove("recording"); if(recognition) recognition.stop(); }

/* ===== DRAW (MODIFICATA) ===== */

const HOLD_TIME = 10000;
const FADE_SPEED = 0.002;

let particles = [];
let drawing = false;
let frozen = false;
let lastX = 0, lastY = 0;
let stopTime = null;
let globalAlpha = 1;

/* metriche disegno */
let strokeCount = 0;
let horizontal = 0;
let vertical = 0;
let startTime = 0;

function initCanvas(){
  const c = canvas;
  const ctx = c.getContext("2d");
  c.width = c.offsetWidth;
  c.height = c.offsetHeight;

  particles = [];
  globalAlpha = 1;
  frozen = false;
  stopTime = null;

  strokeCount = 0;
  horizontal = 0;
  vertical = 0;
  startTime = 0;
  drawSupport.classList.remove("show");
  drawSupport.classList.add("hidden");

  function addParticle(x,y){
    particles.push({ x, y, r: 2.8 });
  }

  c.onpointerdown = e => {
    drawing = true;
    frozen = false;
    globalAlpha = 1;
    stopTime = null;

    startTime = Date.now();
    strokeCount = 0;
    horizontal = 0;
    vertical = 0;

    lastX = e.offsetX;
    lastY = e.offsetY;
    c.setPointerCapture(e.pointerId);
  };

  c.onpointerup = e => {
    drawing = false;
    frozen = true;
    stopTime = Date.now();
    c.releasePointerCapture(e.pointerId);
  };

  c.onpointerleave = () => {
    if(drawing){
      drawing = false;
      frozen = true;
      stopTime = Date.now();
    }
  };

  c.onpointermove = e => {
    if(!drawing) return;

    strokeCount++;
    const dx = Math.abs(e.offsetX - lastX);
    const dy = Math.abs(e.offsetY - lastY);
    if(dx > dy) horizontal++; else vertical++;

    addParticle(e.offsetX, e.offsetY);
    lastX = e.offsetX;
    lastY = e.offsetY;

    checkDrawing();
  };

  function animate(){
    ctx.clearRect(0,0,c.width,c.height);

    if(frozen && stopTime && Date.now() - stopTime > HOLD_TIME){
      globalAlpha -= FADE_SPEED;
      if(globalAlpha < 0) globalAlpha = 0;
    }

    ctx.globalAlpha = globalAlpha;

    particles.forEach(p=>{
      const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r);
      g.addColorStop(0,"rgba(220,220,241,1)");
      g.addColorStop(1,"rgba(241,241,241,0)");
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    });

    ctx.globalAlpha = 1;
    requestAnimationFrame(animate);
  }

  animate();
}
let drawSupportShown = false;

function checkDrawing(){

  const elapsed = (Date.now() - startTime) / 1000;

  // 1Ô∏è‚É£ tensione continua
  if(!drawSupportShown && strokeCount > 600 && elapsed > 5){
    drawSupportShown = true;
    showDrawSupport(
      "Sembra che tu stia scaricando molta tensione. Prenderti un momento per respirare pu√≤ aiutare. Sei al sicuro qui."
    );
    return;
  }

  // 2Ô∏è‚É£ caos / rabbia / confusione
  if(!chaosSupportShown && directionChanges > 25){
    chaosSupportShown = true;
    showDrawSupport(
      "Il rispetto per la vita, nostra e degli altri, √® fondamentale. Se stai provando rabbia o confusione, parlarne con qualcuno pu√≤ aiutare."
    );
  }
}

function showDrawSupport(text){
  drawSupport.innerHTML = text;
  drawSupport.classList.add("show");
  drawSupport.classList.remove("hidden");
}
</script>

</body>
</html>
