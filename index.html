<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spazio Sicuro</title>

<style>
* { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
body {
  margin:0;
  background: linear-gradient(135deg,#0f0f0f,#1a1a2e);
  color:#f1f1f1;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.container {
  width:100%;
  max-width:420px;
  padding:24px;
  text-align:center;
  animation: fadeIn 0.6s ease;
}
h1 {
  font-weight:600;
  font-size:1.8em;
  margin-bottom:16px;
  text-shadow:1px 1px 4px rgba(0,0,0,0.7);
}
p { color:#d0d0d0; line-height:1.6; }
button {
  width:100%;
  padding:14px;
  margin-top:16px;
  background:linear-gradient(90deg,#1c1c1c,#2a2a2a);
  color:#f1f1f1;
  border:none;
  border-radius:12px;
  font-size:16px;
  cursor:pointer;
  transition: background 0.3s, transform 0.2s;
}
button:hover { transform: scale(1.03); }
button:active { transform: scale(0.98); }
button.recording { background: #8b0000; }
button.pulse { animation: pulse 2s infinite; }

.hidden { display:none; }

textarea {
  width:100%;
  height:150px;
  background:#1a1a1a;
  color:#f1f1f1;
  border:none;
  border-radius:12px;
  padding:12px;
  font-size:15px;
  resize:none;
  margin-top:16px;
  box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
}

canvas {
  width:100%;
  height:240px;
  background:linear-gradient(to bottom,#1a1a1a,#0f0f0f);
  border-radius:8px;
  margin-top:16px;
  touch-action: none; /* IMPORTANTISSIMO PER TOUCH */
}

.support {
  background:#141414;
  border-left:3px solid #6f9cff;
  padding:12px;
  margin-top:16px;
  font-size:14px;
  color:#e0e0e0;
  opacity:0;
  transition: opacity 0.6s ease;
}
.support.show { opacity:1; }

@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes pulse { 0%,100%{transform: scale(1);} 50%{transform: scale(1.05);} }
</style>
</head>

<body>

<div class="container" id="welcome">
  <h1>Benvenuto nel tuo spazio sicuro</h1>
  <p>Qui puoi scrivere, disegnare o parlare liberamente.<br>Nessuno ti giudica. Nulla viene salvato.</p>
  <button class="pulse" onclick="goToModes()">Entra</button>
</div>

<div class="container hidden" id="modes">
  <p>Scegli come esprimerti</p>
  <button onclick="openWrite()">‚úçÔ∏è Scrivi</button>
  <button onclick="openDraw()">üñ§ Disegna</button>
  <button onclick="openVoice()">üéôÔ∏è Parla</button>
</div>

<div class="container hidden" id="write">
  <textarea id="writeText" placeholder="Scrivi come viene..."></textarea>
  <div id="writeSupport" class="support hidden"></div>
  <button onclick="release()">Lascia andare</button>
  <button onclick="eliminate()">Elimina</button>
</div>

<div class="container hidden" id="draw">
  <canvas id="canvas"></canvas>
  <div id="drawSupport" class="support hidden"></div>
  <button onclick="release()">Lascia andare</button>
  <button onclick="eliminate()">Elimina</button>
</div>

<div class="container hidden" id="voice">
  <p>Tieni premuto e parla</p>
  <button id="recordBtn">üéôÔ∏è Tieni premuto</button>
  <textarea id="transcript" readonly placeholder="Le tue parole appariranno qui..."></textarea>
  <div id="voiceSupport" class="support hidden"></div>
  <button onclick="release()">Lascia andare</button>
  <button onclick="eliminate()">Elimina</button>
</div>

<div class="container hidden" id="done"><p></p><button onclick="reset()">Torna all'inizio</button></div>
<div class="container hidden" id="eliminated"><p></p><button onclick="reset()">Torna all'inizio</button></div>

<script>
/* ===== NAV ===== */
function hideAll(){ document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden')); }
function goToModes(){ hideAll(); modes.classList.remove('hidden'); }
function openWrite(){ hideAll(); write.classList.remove('hidden'); }
function openDraw(){ hideAll(); draw.classList.remove('hidden'); initCanvas(); }
function openVoice(){ hideAll(); voice.classList.remove('hidden'); }

/* ===== MESSAGES ===== */
const eliminatedMessages=[
  "Non avere paura di esprimere i tuoi pensieri. Sfogarsi fa bene.",
  "Liberare ci√≤ che senti √® un passo verso il tuo benessere.",
  "Hai fatto bene a lasciare andare ci√≤ che pesava.",
  "Ricorda: esprimersi non √® mai sbagliato."
];
const releasedMessages=[
  "Hai condiviso il tuo pensiero, anche solo con te stesso.",
  "Ogni parola lasciata andare √® un piccolo sollievo.",
  "Bene, hai fatto spazio dentro di te.",
  "Lasciare andare fa parte del prendersi cura di s√©."
];
function randomMessage(a){ return a[Math.floor(Math.random()*a.length)]; }

/* ===== RELEASE ===== */
function release(){
  hideAll();
  done.classList.remove("hidden");
  done.querySelector("p").innerHTML=randomMessage(releasedMessages);
}
function eliminate(){
  hideAll();
  eliminated.classList.remove("hidden");
  eliminated.querySelector("p").innerHTML=randomMessage(eliminatedMessages);
}
function reset(){ location.reload(); }

/* ===== SAFETY ===== */
const selfHarmWords=["suicid","ammazzarm","ucciderm","voglio morire","non voglio vivere","farla finita","farmi del male"];
const harmOthersWords=["ammazz","uccid","violenza","vendetta","fare del male"];
function checkText(text,box){
  const t=text.toLowerCase();
  if(selfHarmWords.some(w=>t.includes(w))){
    box.innerHTML="Quello che provi merita ascolto e cura.";
    box.classList.add("show"); box.classList.remove("hidden");
  } else if(harmOthersWords.some(w=>t.includes(w))){
    box.innerHTML="La vita degli altri ha lo stesso valore della nostra.";
    box.classList.add("show"); box.classList.remove("hidden");
  } else {
    box.classList.remove("show"); box.classList.add("hidden");
  }
}
writeText.addEventListener("input",e=>checkText(e.target.value,writeSupport));

/* ===== VOICE ===== */
let recognition;
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
if(SR){
  recognition=new SR();
  recognition.lang="it-IT";
  recognition.continuous=true;
  recognition.interimResults=true;
  recognition.onresult=e=>{
    let text="";
    for(let i=0;i<e.results.length;i++) text+=e.results[i][0].transcript;
    transcript.value=text;
    checkText(text,voiceSupport);
  };
}
recordBtn.onmousedown=startRec;
recordBtn.onmouseup=stopRec;
recordBtn.ontouchstart=startRec;
recordBtn.ontouchend=stopRec;
function startRec(){ recordBtn.textContent="üéôÔ∏è Sto ascoltando..."; recordBtn.classList.add("recording"); recognition && recognition.start(); }
function stopRec(){ recordBtn.textContent="üéôÔ∏è Tieni premuto"; recordBtn.classList.remove("recording"); recognition && recognition.stop(); }

/* ===== DRAW (nitido 10s + dissolvenza DOPO) ===== */

const HOLD_TIME = 10000;
const FADE_SPEED = 0.002;

let particles = [];
let drawing = false;
let frozen = false;
let lastX = 0, lastY = 0;
let stopTime = null;
let globalAlpha = 1;

function initCanvas(){
  const c = canvas;
  const ctx = c.getContext("2d");
  c.width = c.offsetWidth;
  c.height = c.offsetHeight;

  particles = [];
  globalAlpha = 1;
  frozen = false;
  stopTime = null;

  function addParticle(x,y){
    particles.push({
      x, y,
      r: 2.8   // dimensione fissa ‚Üí immagine pi√π nitida
    });
  }

  c.onpointerdown = e => {
    drawing = true;
    frozen = false;
    globalAlpha = 1;
    stopTime = null;
    lastX = e.offsetX;
    lastY = e.offsetY;
    c.setPointerCapture(e.pointerId);
  };

  c.onpointerup = e => {
    drawing = false;
    frozen = true;
    stopTime = Date.now();   // ‚è±Ô∏è PARTE ORA
    c.releasePointerCapture(e.pointerId);
  };

  c.onpointerleave = () => {
    if(drawing){
      drawing = false;
      frozen = true;
      stopTime = Date.now();
    }
  };

  c.onpointermove = e => {
    if(!drawing) return;
    addParticle(e.offsetX, e.offsetY);
    lastX = e.offsetX;
    lastY = e.offsetY;
  };

  function animate(){
    ctx.clearRect(0,0,c.width,c.height);

    // üîí DISSOLVENZA SOLO DOPO 10s DI IMMOBILIT√Ä
    if(frozen && stopTime && Date.now() - stopTime > HOLD_TIME){
      globalAlpha -= FADE_SPEED;
      if(globalAlpha < 0) globalAlpha = 0;
    }

    ctx.globalAlpha = globalAlpha;

    particles.forEach(p=>{
      const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r);
      g.addColorStop(0,"rgba(220,220,241,1)");
      g.addColorStop(1,"rgba(241,241,241,0)");
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    });

    ctx.globalAlpha = 1;
    requestAnimationFrame(animate);
  }

  animate();
}

</script>

</body>
</html>
